import{R as k}from"./ratingPopup-03f01249.js";import{A as w}from"./accountClient-16268368.js";import{C as b}from"./coachClient-9554e82c.js";import{P as y}from"./publicClient-ee633572.js";import{aa as S}from"./webClient-e9003e98.js";import{_ as C}from"./video-img1-ca5161b6.js";import{ae as T,G as v,h as n,j as l,k as t,C as p,z as a,B as m,A as g,F as P,V as O,x as j,n as M,ag as W,ah as N}from"./plugin-vue_export-helper-3a3407bb.js";import"./_commonjsHelpers-725317a4.js";import"./vue-router.esm-bundler-0ff22247.js";let R=new y,d=new b,L=new w;const q={components:{RatingPopup:k},data(){return{loadingTip:"",loadingTipType:1,loadingTime:0,loadingInterval:"",loading:!0,banTime:0,showRating:!1,firstRating:!0,showSettingPannel:!1,im_time_interval:"",msgList:[],msgDW:"",isMuted:!0,showLogo:!1,groupId:"",IMToken:"",im_websocket:null,requestId:"",webSocket:{},timer:"",userInfo:{},classId:0,semesterId:"",dateYear:"",courseNameId:"",id:"",courseId:"",showPrompt:!0,liveshow:{},playback:{},onSpeed:"1.0",playerObj:{},chapterObj:{},seek:0,timePoint:0}},destoryed(){this.webSocket.onclose=function(e){console.log(e,"WebSocket 关闭")},this.im_websocket.onclose=function(e){console.log(e,"WebSocket 关闭")},this.chapterObj.ccPlaybackId&&this.chapterObj.liveRootId&&$.DW.destroy(),clearInterval(this.timer),clearInterval(this.loadingInterval)},async created(){this.id=this.$route.query.id,this.courseId=this.$route.query.courseId,this.classId=this.$route.query.classId,this.semesterId=this.$route.query.semesterId,this.dateYear=this.$route.query.dateYear,this.courseNameId=this.$route.query.courseNameId;let e=await L.checkLogIn();e&&(this.userInfo=await e,R.checkIsOrder(1,this.courseId).then(s=>{if(!s){window.location.href=`/coachcourse/liveCourse?id=${this.courseId}`;return}}),this.classId?await this.getWatchStatus():this.loading=!1,await this.getLiveData())},methods:{getWatchStatus(){d.getWatchStatus().then(e=>{e.code==1?(this.loading=!0,this.loadingTipType=3,this.loadingTip=e.msg):this.webSocketConnection()})},clickClose(e){this.showRating=e,this.getMyRatingList()},getMyRatingList(){d.getMyRatingList({courseId:this.courseId,chapterId:this.id}).then(e=>{e.data.length>0?this.firstRating=!1:this.firstRating=!0})},submit(){if(this.msgDW==""){alert("请输入聊天内容~");return}d.imSendGroupMsg(this.groupId,this.msgDW,this.IMToken).then(e=>{e.code==200?(this.msgDW="",this.$nextTick(()=>{this.$refs.chatContent.scrollTop=this.$refs.chatContent.scrollHeight})):console.log(e,"IM发送失败")})},im_connect(){try{this.im_websocket=new WebSocket("wss://websocket.lingju.cc"),this.im_websocket.onopen=this.im_onOpen,this.im_websocket.onmessage=this.im_onMessage,this.im_websocket.onerror=function(e){console.log(e,"IMWebSocket 报错"),this.im_websocket.onclose=function(s){console.log(s,"IMWebSocket 关闭")}}}catch(e){console.log("new WebSocket error:"+e),setTimeout(()=>{this.im_connect()},1e3)}},im_onOpen(){this.im_websocket.send(JSON.stringify({requestId:this.requestId,reqMsg:this.userInfo.userName,type:1})),this.im_time_interval=window.setInterval(this.im_send,1e4)},im_send(){this.im_websocket.readyState==WebSocket.OPEN&&this.im_websocket.send(JSON.stringify({requestId:this.requestId,reqMsg:"ping msg",type:1}))},im_onMessage(e){let s=JSON.parse(e.data);if(s.type==2){let r=s.reqMsg,h=JSON.parse(r);h.create_time=h.send_time,h.content=h.msg,this.msgList.push(h),this.$nextTick(()=>{this.$refs.chatContent.scrollTop=this.$refs.chatContent.scrollHeight})}},imRegister(){d.imRegister({userId:this.userInfo.userId,headerUrl:this.userInfo.headPortrait,userName:this.userInfo.userName,tenantId:"1533366097988919026"}).then(e=>{this.IMToken=e.data.access_token,this.requestId=e.data.request_id,this.im_connect(),d.imJoinGroup(this.groupId,[this.userInfo.userId+"::"+this.userInfo.userName],this.IMToken).then(s=>{s.code==200&&d.imQueryGroupMsg(this.groupId,1,100,this.IMToken).then(r=>{this.msgList=r.result.list.reverse(),this.$nextTick(()=>{this.$refs.chatContent.scrollTop=this.$refs.chatContent.scrollHeight})})})})},webSocketConnection(){let e=this;try{e.loadingTime==30&&(e.loadingTipType=2);let s=`ws://60.216.20.210:8000/gateway/knowledge/learningRateServer?userId=${e.userInfo.userId}&clientTypeCode=PC&chapterId=${e.id}&classId=${e.classId}&courseId=${e.courseId}&courseNameId=${e.courseNameId}&dateYear=${e.dateYear}&nodeId=&semesterId=${e.semesterId}`;e.webSocket=new WebSocket(s),e.webSocket.onopen=function(){console.log("WebSocket创建成功"),e.loadingTipType!=3&&(e.loading=!1),clearInterval(e.loadingInterval)},e.webSocket.onmessage=function(r){console.log(r,"WebSocket接收数据")}}catch(s){console.log(s,"webSocket错误"),clearInterval(e.loadingInterval),e.loadingInterval=setInterval(()=>{e.loadingTime++},1e3),e.loading=!0,setTimeout(()=>{e.webSocketConnection()},1e3)}},webSocketSend(){this.chapterObj.ccPlaybackId&&this.chapterObj.liveRootId?this.timePoint=parseInt($.DW.getPlayerTime()):this.timePoint=parseInt(this.playerObj.getCurrentTime());let e={classId:this.classId,semesterId:this.semesterId,dateYear:this.dateYear,courseNameId:this.courseNameId,courseId:this.courseId,chapterId:this.id,nodeId:"",userId:this.userInfo.userId,clientType:"PC",videoTypeCode:1,videoDuration:this.chapterObj.totalTime,currentSeeSec:this.timePoint,multiple:this.onSpeed,liveStatus:1,liveStartTime:this.chapterObj.liveStartTime};this.webSocket.readyState==1&&this.webSocket.send(JSON.stringify(e))},async getLiveData(){let e=await d.queryCourseDetails(this.courseId);this.liveshow=e.data;for(let r of e.data.liveList)if(r.liveChapterId==this.id){this.chapterObj=r,this.groupId=r.groupId,document.title=r.liveChapterName;var s=await parseInt(this.$dayjs().unix())-parseInt(this.$dayjs(this.chapterObj.liveStartTime).unix());this.seek=await s}if(this.chapterObj.liveCourseStatus==0){alert("直播尚未开始~"),this.$router.go(-1);return}if(this.chapterObj.liveCourseStatus==2){alert("回放生成中~"),this.$router.go(-1);return}if(this.chapterObj.liveCourseStatus==3){alert("直播回放中~"),this.$router.go(-1);return}await this.getMyRatingList(),this.chapterObj.liveCourseStatus==1&&await this.initCCPlayer(),await this.imRegister()},clickVoice(){var e=$("#playbackVideo")[0];e.muted=!1,this.isMuted=!1},initCCPlayer(){$.DW.config({userId:"41A331E332E32281",roomId:this.chapterObj.liveRootId,recordId:this.chapterObj.ccPlaybackId,isH5play:!0,fastMode:!0}),$.DW.isShowBar(1);var e=this;window.on_player_start=function(){clearInterval(e.timer),e.timer=setInterval(()=>{e.webSocketSend()},1e3),e.webSocket.readyState==3&&e.webSocketConnection()},window.on_spark_player_pause=async function(){clearInterval(e.timer)},window.on_cc_live_player_load=function(){var s=$("#playbackVideo")[0];s.muted=!0,$.DW.play(),e.showLogo=!0},window.on_cc_swf_loading_completed=function(){e.seek>0&&$.DW.seek(e.seek)},window.on_spark_player_end=function(){e.firstRating&&(e.showRating=!0),document.webkitFullscreenElement&&document.webkitCancelFullScreen()}},clickFullScreen(){let e=document.webkitFullscreenElement,s=document.getElementById("playbackPanel");e?document.webkitCancelFullScreen():s.webkitRequestFullScreen(),setTimeout(()=>{this.showSettingPannel=!1},2e3)}}},c=e=>(W("data-v-1fd7d0cc"),e=e(),N(),e),D={class:"pannel"},x={class:"video-pannel"},E={key:0,class:"loading-mask"},V={key:0,class:"loading-con"},F=c(()=>t("div",null,"缓冲中，请稍后",-1)),B={key:1,class:"tip-con"},Y=c(()=>t("div",{class:"mb30"},"网络错误，与服务器断开",-1)),H={class:"btn-con"},J={key:2,class:"tip-con"},z={class:"mb30"},A={class:"btn-con"},G={class:"video-con"},U={class:"video-left"},Q={class:"video-title"},K=["title"],X={class:"teacher"},Z={class:"tea-img"},ee=["src"],te={key:0,class:"player-Prompt"},se=c(()=>t("div",{class:"icon"},[t("i",{class:"iconfont iconzhuyi"})],-1)),ie=c(()=>t("div",{class:"text"}," 课程视频版权所有，禁止任何形式得转载！并未经本公司书面许可的使用行为，我公司均保留追究法律责任的权利。 ",-1)),oe=c(()=>t("i",{class:"iconfont iconguanbi"},null,-1)),ne={id:"playbackPanel",style:{width:"100%",height:"100%"}},le={key:0,class:"setting-pannel"},re={class:"player-function"},ce={class:"teacher-video"},ae={key:0,class:"style1"},de=c(()=>t("div",{id:"playbackPlayer",style:{width:"100%",height:"100%"}},null,-1)),he=[de],ue={key:1},me=c(()=>t("img",{src:C},null,-1)),pe=[me],ge={class:"mask-con"},_e=c(()=>t("i",{class:"iconfont iconxiaolaba"},null,-1)),ve={class:"playback-talk"},Ie=c(()=>t("div",{class:"text"},"聊天区",-1)),fe={class:"msg-list",id:"msg-list",ref:"chatContent"},ke={class:"user-con"},we=["src"],be={class:"name"},ye={class:"msg"},Se=["innerHTML"],Ce={class:"msg-btn"},Te={class:"btn-block"};function Pe(e,s,r,h,i,u){const _=v("el-svg-icon"),I=v("rating-popup");return n(),l("div",D,[t("div",x,[i.loading?(n(),l("div",E,[i.loadingTipType==1?(n(),l("div",V,[p(_,{name:"Loading",size:20,color:"#fff",class:"icon"}),F])):a("",!0),i.loadingTipType==2?(n(),l("div",B,[Y,t("div",H,[t("div",{onClick:s[0]||(s[0]=o=>i.loadingTipType=1)},"继续等待"),t("div",{onClick:s[1]||(s[1]=o=>e.reloadPage())},"重新播放")])])):a("",!0),i.loadingTipType==3?(n(),l("div",J,[t("div",z,m(i.loadingTip),1),t("div",A,[t("div",{onClick:s[2]||(s[2]=(...o)=>e.closeWindow&&e.closeWindow(...o))},"我知道了")])])):a("",!0)])):a("",!0),t("div",G,[t("div",U,[t("div",Q,[t("div",{class:"title oneEllipsis",title:i.chapterObj.liveChapterName},m(i.chapterObj.liveChapterName),9,K),t("div",X,[t("div",Z,[t("img",{src:i.liveshow.teacherPortrait,alt:""},null,8,ee)]),g(" 讲师："+m(i.liveshow.teacherName),1)])]),i.showPrompt?(n(),l("div",te,[se,ie,t("div",{class:"player-Prompt-close",onClick:s[3]||(s[3]=o=>i.showPrompt=!1)},[g(" 关闭 "),oe])])):a("",!0),i.chapterObj&&i.chapterObj.ccPlaybackId&&i.chapterObj.liveRootId?(n(),l("div",{key:1,class:"player-main",onMouseover:s[5]||(s[5]=o=>i.showSettingPannel=!0),onMouseleave:s[6]||(s[6]=o=>i.showSettingPannel=!1)},[t("div",ne,[t("div",{class:"play-mask",onClick:s[4]||(s[4]=o=>i.showSettingPannel=!i.showSettingPannel)},[i.showSettingPannel?(n(),l("div",le,[p(_,{name:"FullScreen",color:"#fff",size:30,class:"full-screen-btn",title:"点击全屏/取消全屏",onClick:u.clickFullScreen},null,8,["onClick"])])):a("",!0)])])],32)):a("",!0)]),t("div",re,[t("div",ce,[i.chapterObj&&i.chapterObj.ccPlaybackId&&i.chapterObj.liveRootId?(n(),l("div",ae,he)):(n(),l("div",ue,pe)),t("div",ge,[i.isMuted?(n(),l("div",{key:0,class:"showLiveBtn",onClick:s[7]||(s[7]=(...o)=>u.clickVoice&&u.clickVoice(...o))},[_e,g("打开声音 ")])):a("",!0)])]),t("div",ve,[Ie,t("div",fe,[(n(!0),l(P,null,O(i.msgList,(o,f)=>(n(),l("div",{class:M(["msg-item",o.user_id==i.userInfo.userId?"my":""]),key:f},[t("div",ke,[t("img",{src:o.header_url,alt:"",class:"head-img"},null,8,we),t("div",be,m(o.user_name),1)]),t("div",ye,[t("div",{innerHTML:o.content},null,8,Se)])],2))),128))],512),t("div",Ce,[t("div",Te,[j(t("input",{placeholder:"参与聊天","onUpdate:modelValue":s[8]||(s[8]=o=>i.msgDW=o)},null,512),[[S,i.msgDW]]),t("div",{class:"submit",onClick:s[9]||(s[9]=o=>u.submit())},"发送")])])])])])]),p(I,{show:i.showRating,courseId:i.courseId,chapterId:i.id,onClickClose:u.clickClose},null,8,["show","courseId","chapterId","onClickClose"])])}const xe=T(q,[["render",Pe],["__scopeId","data-v-1fd7d0cc"]]);export{xe as default};
